<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <title>Blast</title>
        <link rel="stylesheet" href="css/foundation.css" />
        <script src="http://code.jquery.com/jquery-2.0.0.js"></script>
        <script src="js/vendor/custom.modernizr.js"></script>
        <script type="text/javascript">
            $(document).ready(function() {
                $('#blastform-type').change(function(){
                    var blasttype = $(this).val();
                    $('.type-switched').not('.'+blasttype).hide();
                    $('.type-switched.'+blasttype).show();
                });

                $('#blastform-type').change();

                $("#blastform").submit(function() {
                    data = { additional_data: {} };
                    
                    var that = $(this);
                    $.each($(this).serializeArray(), function() {
                        if (!$('#blastform [name="'+this.name+'"]').is(':visible')){
                            return; //skip this parameter, it's input field is not visible'
                        }
                        var matches = this.name.match(/^(\w+)\[(\w+)\]$/);
                        if ($.isArray(matches)) {
                            if (typeof data[matches[1]] === 'undefined')
                                data[matches[1]] = {};
                            data[matches[1]][matches[2]] = this.value;
                        } else {
                            data[this.name] = this.value;
                        }
                    });
                    that.find('input[type="submit"]').prop('disabled', true);
                    $.ajax(that.attr('action'), {
                        data: {job: data},
                        type: that.attr('method'),
                        dataType: 'JSON',
                        complete: function() {
                            that.find('input[type="submit"]').prop('disabled', false);
                        },
                        success: function(ret) {
                            if (ret.status==='success'){
                                window.location(that.attr('data-goto')+ret);
                            } else {
                                console.log(ret);
                                alert(ret.message);
                            }
                        }
                    });
                    return false;
                });
            });
        </script>
    </head>
    <body>
        <div class="row">
            <div class="large-12 columns">
                <h2>Blast</h2>
            </div>
            <div class="large-12 columns panel">

                <form id="blastform" method="POST" action="ajax/blast_start.php" data-goto="blast-results.php?jobid=">
                    <div class="row">
                        <div class="large-12 columns">
                            <label for="blastform-type">Blast type:</label>
                            <select id="blastform-type" name="type"><option>blastn</option><option>blastp</option><option>blastx</option><option>tblastn</option><option>tblastx</option></select>    
                        </div>
                    </div>
                    <div class="row">

                        <div class="large-12 columns">
                            <label for="blastform-query">FASTA sequence(s):</label>
                            <textarea id="blastform-query" name="query" style="width:100%; height:200px; white-space: nowrap;">

                            </textarea>
                        </div>
                    </div>
                    <ul class="large-block-grid-5">
                        <li>
                            <label for="blastform-num_descriptions">Number of Descriptions:</label>
                            <select id="blastform-num_descriptions" name="parameters[num_descriptions]" style="width:auto"><option>10</option><option>50</option><option>100</option><option>250</option><option>1000</option></select>
                        </li>
                        <li>
                            <label for="blastform-num_alignments">Number of Alignments:</label>
                            <select id="blastform-num_alignments" name="parameters[num_alignments]" style="width:auto"><option>10</option><option>50</option><option>100</option><option>250</option><option>1000</option></select>
                        </li>
                        <li>
                            <label for="blastform-evalue">Maximum E-value:</label>
                            <select id="blastform-evalue" name="parameters[evalue]" style="width:auto"><option>0.01</option><option selected="selected">0.1</option><option>1.0</option><option>10</option><option>100</option></select>
                        </li>
                        <li class="type-switched blastn">
                            <label for="blastform-task">Task:</label>
                            <select id="blastform-task" name="parameters[task]" style="width:auto"><option>blastn</option><option>dc-megablast</option><option>megablast</option></select>
                        </li>
                        <li class="type-switched blastp blastx tblastn tblastx">
                            <label for="blastform-matrix">Matrix:</label>
                            <select id="blastform-matrix" name="parameters[matrix]" style="width:auto">
                                <option >BLOSUM45</option>
                                <option >BLOSUM50</option>
                                <option selected="selected">BLOSUM62</option>
                                <option >BLOSUM80</option>
                                <option >BLOSUM90</option>
                                <option >PAM30</option>
                                <option >PAM70</option>
                                <option >PAM250</option>
                            </select>
                        </li>
                    </ul>
                    <div class="row">
                        <div class="large-2 large-offset-10 columns"><br/><input type="submit" class="button" value="start job"/></div>
                    </div>
                </form>
            </div>
        </div>
    </body>
</html>